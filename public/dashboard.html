<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Student Progress Tracker</title>
  <meta name="description" content="Your academic progress dashboard with real-time statistics.">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>

  <div class="app-layout">
    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/dashboard" class="nav-logo">
          <div class="logo-icon"><i class="fas fa-graduation-cap"></i></div>
          ProgressTrack
        </a>
      </div>

      <nav class="sidebar-nav">
        <div class="sidebar-nav-label">Main Menu</div>
        <a href="/dashboard" class="sidebar-nav-item active" id="nav-dashboard">
          <i class="fas fa-th-large"></i>
          Dashboard
        </a>
        <a href="/subjects" class="sidebar-nav-item" id="nav-subjects">
          <i class="fas fa-book-open"></i>
          Subjects
        </a>
        <a href="/goals" class="sidebar-nav-item" id="nav-goals">
          <i class="fas fa-bullseye"></i>
          Goals
        </a>
        <a href="/analytics" class="sidebar-nav-item" id="nav-analytics">
          <i class="fas fa-chart-bar"></i>
          Analytics
        </a>

        <div class="sidebar-nav-label" style="margin-top: var(--space-lg);">Account</div>
        <a href="#" class="sidebar-nav-item" onclick="logoutUser()">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="sidebar-avatar">US</div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name user-display-name">Loading...</div>
            <div class="sidebar-user-email user-display-email">...</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Navbar -->
      <header class="top-navbar">
        <div class="top-navbar-left">
          <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
          </button>
          <h1 class="page-title">Dashboard</h1>
        </div>
        <div class="top-navbar-right">
          <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Theme">
            <i class="fas fa-moon theme-toggle-icon"></i>
          </button>
          <div class="navbar-user">
            <i class="fas fa-user-circle" style="font-size:1.375rem; color: var(--primary-500);"></i>
            <span class="navbar-user-name user-display-name">Loading...</span>
          </div>
        </div>
      </header>

      <!-- Page Content -->
      <main class="page-content" id="dashboard-content">
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="/js/firebase-config.js"></script>
  <script src="/js/ui.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/firestore.js"></script>
  <script src="/js/progress.js"></script>
  <script src="/js/streaks.js"></script>
  <script src="/js/goals.js"></script>
  <script src="/js/insights.js"></script>
  <script src="/js/notifications.js"></script>

  <script>
    // Protect page
    requireAuth().then(async (user) => {
      updateUserUI(user);
      await loadDashboard();
    });

    async function loadDashboard() {
      const content = document.getElementById('dashboard-content');

      try {
        const stats = await getDashboardStats();
        const streakData = await getStreakData();
        const goals = await getGoalsOnce();
        const notifications = generateNotifications(stats, goals, streakData);

        content.innerHTML = `
          <!-- Stats Cards -->
          <div class="stats-grid">
            <div class="stat-card blue animate-in">
              <div class="stat-icon"><i class="fas fa-book-open"></i></div>
              <div class="stat-info">
                <h3>${stats.totalSubjects}</h3>
                <p>Total Subjects</p>
              </div>
            </div>
            <div class="stat-card green animate-in">
              <div class="stat-icon"><i class="fas fa-list-check"></i></div>
              <div class="stat-info">
                <h3>${stats.totalTopics}</h3>
                <p>Total Topics</p>
              </div>
            </div>
            <div class="stat-card orange animate-in">
              <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
              <div class="stat-info">
                <h3>${stats.completionPercent}%</h3>
                <p>Completed Topics</p>
              </div>
            </div>
            <div class="stat-card purple animate-in">
              <div class="stat-icon"><i class="fas fa-star"></i></div>
              <div class="stat-info">
                <h3>${stats.avgScore || '—'}</h3>
                <p>Average Score</p>
              </div>
            </div>
          </div>

          <!-- Overall Progress -->
          <div class="progress-section animate-in">
            <h3><i class="fas fa-tasks" style="color: var(--primary-500); margin-right: 0.5rem;"></i>Overall Completion Progress</h3>
            <div class="progress-info">
              <span>${stats.completedTopics} of ${stats.totalTopics} topics completed</span>
              <span>${stats.completionPercent}%</span>
            </div>
            <div class="progress-bar-wrapper">
              <div class="progress-bar-fill" style="width: ${stats.completionPercent}%"></div>
            </div>
          </div>

          <!-- Widget Row: Streak + Goals -->
          <div class="dashboard-widgets">
            <div id="streak-widget"></div>
            <div id="goals-widget"></div>
          </div>

          <!-- Widget Row: Insights + Notifications -->
          <div class="dashboard-widgets">
            <div id="insights-widget"></div>
            <div id="notifications-widget"></div>
          </div>

          <!-- Widget Row: Badges + Progress Timeline -->
          <div class="dashboard-widgets">
            <div id="badges-widget"></div>
            <div id="progress-timeline-widget"></div>
          </div>

          <!-- Recent Subjects -->
          <div class="recent-subjects animate-in">
            <div class="section-header">
              <h3><i class="fas fa-clock" style="color: var(--primary-500); margin-right: 0.5rem;"></i>Your Subjects</h3>
              <a href="/subjects" class="btn btn-outline btn-sm">View All</a>
            </div>
            <div id="recent-subjects-list">
              ${stats.subjects.length > 0 ? renderRecentSubjects(stats.subjects) : `
                <div class="empty-state">
                  <div class="empty-state-icon"><i class="fas fa-book-open"></i></div>
                  <h3>No Subjects Yet</h3>
                  <p>Start by adding your first subject to track progress.</p>
                  <a href="/subjects" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Subject</a>
                </div>
              `}
            </div>
          </div>
        `;

        // Render widgets
        renderStreakWidget('streak-widget', streakData);
        renderGoalsWidget('goals-widget', goals);
        renderInsightsWidget('insights-widget', stats.subjects, stats.allTopics);
        renderNotificationPanel('notifications-widget', notifications);

        // Render gamification widgets
        try {
          const [badges, progressHistory] = await Promise.all([
            getEarnedBadges(),
            getProgressHistory(10)
          ]);
          renderBadgesShowcase('badges-widget', badges);
          renderProgressTimeline('progress-timeline-widget', progressHistory);
        } catch (e) {
          console.log('Gamification widgets error:', e.message);
        }

      } catch (error) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <h3>Error Loading Dashboard</h3>
            <p>${error.message || 'Please try refreshing the page.'}</p>
            <button class="btn btn-primary btn-sm" onclick="location.reload()">Refresh</button>
          </div>
        `;
      }
    }

    function renderRecentSubjects(subjects) {
      return subjects.slice(0, 5).map(subject => `
        <div class="topic-item" style="cursor: pointer;" onclick="window.location.href='/topics/${subject.id}'">
          <div class="subject-card-icon" style="width:36px;height:36px;border-radius:var(--radius-md);font-size:1rem;">
            <i class="fas fa-book"></i>
          </div>
          <div class="topic-info" style="flex:1;">
            <h4>${subject.name}</h4>
            <p>${subject.totalTopics || 0} topics · ${subject.completionPercent || 0}% complete</p>
          </div>
          <div style="width:100px;">
            <div class="progress-bar-wrapper" style="height:6px;">
              <div class="progress-bar-fill" style="width: ${subject.completionPercent || 0}%"></div>
            </div>
          </div>
          <span class="badge ${subject.completionPercent === 100 ? 'badge-success' : subject.completionPercent >= 50 ? 'badge-primary' : 'badge-warning'}">
            ${subject.completionPercent || 0}%
          </span>
        </div>
      `).join('');
    }
  </script>
</body>

</html>