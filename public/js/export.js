// ============================================
// Export Module - PDF report generation
// ============================================

// Generate downloadable PDF report
async function generatePDFReport(stats, subjects, allTopics) {
    // Check if jsPDF is available
    if (typeof window.jspdf === 'undefined') {
        showToast('PDF library is loading, please try again.', 'warning');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const user = getCurrentUser();
    const userName = user ? (user.displayName || user.email) : 'Student';
    const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

    // Colors
    const primary = [59, 130, 246];
    const dark = [30, 41, 59];
    const gray = [100, 116, 139];
    const green = [16, 185, 129];
    const red = [239, 68, 68];

    let y = 20;

    // Header
    doc.setFillColor(...primary);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(22);
    doc.setFont('helvetica', 'bold');
    doc.text('Student Progress Report', 15, 18);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    doc.text(`${userName}  |  ${today}`, 15, 28);
    doc.text('Generated by ProgressTrack', 15, 35);

    y = 50;

    // Summary Statistics
    doc.setTextColor(...dark);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Summary Statistics', 15, y);
    y += 10;

    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(...gray);

    const summaryData = [
        ['Total Subjects', `${stats.totalSubjects}`],
        ['Total Topics', `${stats.totalTopics}`],
        ['Completed Topics', `${stats.completedTopics}`],
        ['Completion Rate', `${stats.completionPercent}%`],
        ['Average Score', `${stats.avgScore || 'N/A'}`]
    ];

    summaryData.forEach(([label, value]) => {
        doc.setTextColor(...gray);
        doc.text(label + ':', 20, y);
        doc.setTextColor(...dark);
        doc.setFont('helvetica', 'bold');
        doc.text(value, 80, y);
        doc.setFont('helvetica', 'normal');
        y += 8;
    });

    y += 5;

    // Subject Performance Table
    doc.setTextColor(...dark);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Subject Performance', 15, y);
    y += 10;

    // Table header
    doc.setFillColor(241, 245, 249);
    doc.rect(15, y - 5, 180, 8, 'F');
    doc.setFontSize(10);
    doc.setTextColor(...dark);
    doc.text('Subject', 20, y);
    doc.text('Topics', 80, y);
    doc.text('Done', 105, y);
    doc.text('Completion', 130, y);
    doc.text('Avg Score', 165, y);
    y += 10;

    doc.setFont('helvetica', 'normal');
    subjects.forEach(s => {
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
        doc.setTextColor(...dark);
        doc.text(s.name.substring(0, 25), 20, y);
        doc.setTextColor(...gray);
        doc.text(`${s.totalTopics}`, 85, y);
        doc.text(`${s.completedTopics}`, 110, y);

        const pct = s.completionPercent || 0;
        doc.setTextColor(pct >= 80 ? green[0] : pct >= 50 ? 245 : red[0],
            pct >= 80 ? green[1] : pct >= 50 ? 158 : red[1],
            pct >= 80 ? green[2] : pct >= 50 ? 11 : red[2]);
        doc.text(`${pct}%`, 138, y);

        const score = s.avgScore || 0;
        doc.setTextColor(score >= 80 ? green[0] : score >= 50 ? 245 : red[0],
            score >= 80 ? green[1] : score >= 50 ? 158 : red[1],
            score >= 80 ? green[2] : score >= 50 ? 11 : red[2]);
        doc.text(`${score || 'N/A'}`, 172, y);
        y += 8;
    });

    y += 10;

    // Performance Insights
    if (y > 240) { doc.addPage(); y = 20; }
    doc.setTextColor(...dark);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Performance Insights', 15, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');

    const weak = detectWeakSubjects(subjects);
    if (weak.length > 0) {
        doc.setTextColor(...red);
        doc.text(`⚠ Weak Subjects: ${weak.map(s => s.name).join(', ')}`, 20, y);
        y += 7;
    }

    const prediction = predictPerformance(allTopics);
    if (prediction) {
        doc.setTextColor(...(prediction.trend === 'up' ? green : prediction.trend === 'down' ? red : gray));
        doc.text(`Predicted Next Score: ${prediction.predicted}% (Trend: ${prediction.trend})`, 20, y);
        y += 7;
    }

    // Capture charts if they exist
    try {
        const chartCanvases = document.querySelectorAll('.chart-container canvas');
        if (chartCanvases.length > 0) {
            doc.addPage();
            y = 20;
            doc.setTextColor(...dark);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Charts', 15, y);
            y += 10;

            for (const canvas of chartCanvases) {
                if (y > 180) { doc.addPage(); y = 20; }
                const imgData = canvas.toDataURL('image/png');
                doc.addImage(imgData, 'PNG', 15, y, 180, 80);
                y += 90;
            }
        }
    } catch (e) {
        console.log('Could not capture charts:', e);
    }

    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setTextColor(...gray);
        doc.setFontSize(8);
        doc.text(`Page ${i} of ${pageCount} — ProgressTrack Report`, 105, 290, { align: 'center' });
    }

    doc.save(`ProgressTrack_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    showToast('PDF report downloaded!', 'success');
}
